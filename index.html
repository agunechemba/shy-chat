<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>shyChat - Private P2P Group Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { 
            --primary: #6366f1; 
            --primary-dark: #4f46e5;
            --bg: #f1f5f9; 
            --text: #1e293b; 
            --success: #10b981; 
            --panel: #ffffff;
            --error: #ef4444;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, system-ui, sans-serif; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        .view { display: none; width: 100%; max-width: 500px; padding: 2rem; flex-direction: column; gap: 1.5rem; }
        .view.active { display: flex; }
        
        h1 { font-size: 2.5rem; text-align: center; color: var(--primary); font-weight: 800; letter-spacing: -0.025em; }
        p { text-align: center; color: #64748b; line-height: 1.5; }
        
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #94a3b8; transition: all 0.3s; }
        .status-online { background: var(--success); box-shadow: 0 0 8px var(--success); }

        input[type="text"] { padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 0.6rem; font-size: 1rem; width: 100%; outline: none; }
        
        button { padding: 0.8rem; background: var(--primary); color: white; border: none; border-radius: 0.6rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:hover { background: var(--primary-dark); }
        button:disabled { background: #cbd5e1; cursor: not-allowed; }
        
        #chat-view { max-width: 900px; width: 100vw; height: 100vh; display: none; padding: 1rem; flex-direction: column; }
        #chat-view.active { display: flex; }

        #chat-main { flex: 1; display: flex; flex-direction: column; background: var(--panel); border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }

        .chat-header { padding: 1rem 1.5rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: white; }
        .room-info { display: flex; align-items: center; gap: 10px; font-weight: 700; color: var(--primary); }
        .user-count { font-size: 0.85rem; color: #64748b; font-weight: 500; }

        #messages { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; background: #f8fafc; }
        .message { max-width: 75%; padding: 0.8rem 1rem; border-radius: 1rem; background: white; align-self: flex-start; box-shadow: 0 1px 3px rgba(0,0,0,0.1); line-height: 1.4; position: relative; }
        .message.own { background: var(--primary); color: white; align-self: flex-end; }
        .msg-sender { font-size: 0.75rem; margin-bottom: 4px; font-weight: 700; opacity: 0.8; }
        
        #input-area { padding: 1rem; display: flex; gap: 0.75rem; border-top: 1px solid #f1f5f9; align-items: center; background: white; }
        #msg-input { flex: 1; border: 1px solid #e2e8f0; padding: 0.75rem; border-radius: 0.5rem; outline: none; }
        
        .file-label { cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #64748b; }
        #file-input { display: none; }

        .copy-box { background: #fff; padding: 1rem; border: 2px dashed #cbd5e1; border-radius: 0.8rem; font-family: monospace; font-size: 0.85rem; cursor: pointer; word-break: break-all; color: var(--primary); font-weight: 600; text-align: center; }
        .system-msg { align-self: center; background: #e2e8f0; color: #475569; font-size: 0.75rem; font-weight: 600; border-radius: 2rem; padding: 4px 12px; }
        
        .file-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; margin-top: 5px; background: #f1f5f9; min-width: 200px; }
        .progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin: 5px 0; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

    <div id="home-view" class="view active">
        <h1>shyChat</h1>
        <p>Private, serverless group messaging.<br>Created by Agunechemba Ekene.</p>
        <button onclick="startNewChat()">Create Secure Room</button>
    </div>

    <div id="link-view" class="view">
        <h1>Invite Your Circle</h1>
        <p>Share this link. GitHub Pages requires HTTPS for P2P functionality.</p>
        <div id="share-link" class="copy-box" onclick="copyToClipboard()">Generating...</div>
        <button onclick="shareLink()">Share Link</button>
        <button style="background:#e2e8f0; color:#1e293b;" onclick="goToNamePrompt()">Enter Room</button>
    </div>

    <div id="name-view" class="view">
        <h1>Choose a handle</h1>
        <input type="text" id="pseudonym-input" placeholder="Display name..." maxlength="20">
        <button id="join-btn" onclick="joinChat()">Join shyChat</button>
    </div>

    <div id="chat-view">
        <main id="chat-main">
            <header class="chat-header">
                <div class="room-info">
                    <span id="status-dot" class="status-dot"></span>
                    <span>shyChat Room</span>
                </div>
                <div class="user-count" id="user-count-display">1 participant</div>
            </header>
            <div id="messages"></div>
            <div id="input-area">
                <label for="file-input" class="file-label">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                </label>
                <input type="file" id="file-input" onchange="handleFileSelect(event)">
                <input type="text" id="msg-input" placeholder="Say something..." autocomplete="off">
                <button onclick="sendMessage()">Send</button>
            </div>
        </main>
    </div>

    <script>
        const CHUNK_SIZE = 16384; 
        let peer = null;
        let hostPeer = null;
        let connections = {};
        let myName = "Anonymous";
        let roomId = ""; 
        let fileTransferStates = {};
        let processedMessageIds = new Set();

        const iceConfig = {
            'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const chatParam = urlParams.get('chat');
            if (chatParam) {
                roomId = chatParam;
                switchView('name-view');
            }
        };

        function switchView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startNewChat() {
            roomId = "shy-" + Math.random().toString(36).substring(2, 10);
            const chatLink = window.location.origin + window.location.pathname + '?chat=' + roomId;
            document.getElementById('share-link').innerText = chatLink;
            switchView('link-view');
        }

        function copyToClipboard() {
            const link = document.getElementById('share-link').innerText;
            navigator.clipboard.writeText(link).then(() => {
                const box = document.getElementById('share-link');
                const oldText = box.innerText;
                box.innerText = "Link Copied!";
                setTimeout(() => box.innerText = oldText, 2000);
            });
        }

        async function shareLink() {
            const url = document.getElementById('share-link').innerText;
            if (navigator.share) await navigator.share({ title: 'Join my shyChat', url });
            else copyToClipboard();
        }

        function goToNamePrompt() { switchView('name-view'); }

        function joinChat() {
            const inputName = document.getElementById('pseudonym-input').value.trim();
            myName = inputName || "User_" + Math.floor(Math.random()*1000);
            document.getElementById('join-btn').disabled = true;
            document.getElementById('join-btn').innerText = "Connecting...";

            peer = new Peer(null, { config: iceConfig, debug: 1 });

            peer.on('open', (myUniqueId) => {
                switchView('chat-view');
                document.getElementById('chat-view').classList.add('active');
                
                const conn = peer.connect(roomId, { reliable: true });
                setupConnection(conn);
                setupHostCapabilities();
            });

            peer.on('error', (err) => {
                addMessage('System', `Connection Error: ${err.type}`, 'system-msg');
            });
        }

        function setupHostCapabilities() {
            hostPeer = new Peer(roomId, { config: iceConfig });
            hostPeer.on('open', () => {
                addMessage('System', 'You are the room host.', 'system-msg');
            });
            hostPeer.on('connection', (conn) => {
                setupConnection(conn);
            });
            hostPeer.on('error', (err) => {
                if (err.type === 'unavailable-id') console.log("Joined existing mesh.");
            });
        }

        function setupConnection(conn) {
            conn.on('open', () => {
                connections[conn.peer] = { conn, name: "Connecting..." };
                conn.send({ 
                    type: 'handshake', 
                    name: myName, 
                    peers: Object.keys(connections).filter(id => id !== conn.peer) 
                });
                updateUIState();
            });

            conn.on('data', (data) => {
                if (data.msgId) {
                    if (processedMessageIds.has(data.msgId)) return;
                    processedMessageIds.add(data.msgId);
                    broadcast(data, [conn.peer]); 
                }

                if (data.type === 'chat') {
                    addMessage(data.user, data.text);
                } else if (data.type === 'handshake') {
                    const isNew = !connections[conn.peer] || connections[conn.peer].name === "Connecting...";
                    connections[conn.peer].name = data.name;
                    if (isNew) addMessage('System', `${data.name} joined.`, 'system-msg');
                    updateUIState();
                    
                    if (data.peers) {
                        data.peers.forEach(pId => {
                            if (pId !== peer.id && pId !== roomId && !connections[pId]) {
                                const nextConn = peer.connect(pId, { reliable: true });
                                setupConnection(nextConn);
                            }
                        });
                    }
                } else if (data.type === 'file-start') {
                    handleFileStart(data);
                } else if (data.type === 'file-chunk') {
                    handleFileChunk(data);
                }
            });

            conn.on('close', () => {
                if (connections[conn.peer]) {
                    const name = connections[conn.peer].name;
                    delete connections[conn.peer];
                    addMessage('System', `${name} left.`, 'system-msg');
                    updateUIState();
                }
            });
        }

        function updateUIState() {
            const count = Object.values(connections).filter(c => c.name !== "Connecting...").length + 1;
            document.getElementById('user-count-display').innerText = `${count} participant${count !== 1 ? 's' : ''}`;
            document.getElementById('status-dot').classList.add('status-online');
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;
            const msgId = 'm-' + Date.now() + Math.random().toString(36).substr(2,5);
            processedMessageIds.add(msgId);
            const payload = { type: 'chat', user: myName, text, msgId };
            broadcast(payload);
            addMessage('You', text, 'own');
            input.value = '';
        }

        function broadcast(data, exclude = []) {
            Object.values(connections).forEach(c => {
                if (c.conn.open && !exclude.includes(c.conn.peer)) c.conn.send(data);
            });
        }

        function addMessage(user, text, className = '', fileId = null) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${className}`;
            if (className !== 'system-msg') {
                const s = document.createElement('div');
                s.className = 'msg-sender';
                s.innerText = user;
                div.appendChild(s);
            }
            const t = document.createElement('div');
            t.innerText = text;
            div.appendChild(t);
            if (fileId) {
                const card = document.createElement('div');
                card.className = 'file-card';
                card.id = `file-${fileId}`;
                card.innerHTML = `<div class="progress-bar"><div class="progress-fill" id="progress-${fileId}"></div></div>`;
                div.appendChild(card);
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            const fileId = 'f-' + Math.random().toString(36).substr(2,5);
            addMessage('You', `Sending ${file.name}...`, 'own', fileId);
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const buffer = ev.target.result;
                const msgId = 'fm-' + fileId;
                processedMessageIds.add(msgId);
                broadcast({ type: 'file-start', id: fileId, name: file.name, size: file.size, sender: myName, msgId });
                for (let i = 0; i < buffer.byteLength; i += CHUNK_SIZE) {
                    const chunk = buffer.slice(i, i + CHUNK_SIZE);
                    broadcast({ type: 'file-chunk', id: fileId, chunk, index: i });
                    const fill = document.getElementById(`progress-${fileId}`);
                    if (fill) fill.style.width = Math.round((i/file.size)*100) + '%';
                    if (i % (CHUNK_SIZE*5) === 0) await new Promise(r => setTimeout(r, 1));
                }
                const fill = document.getElementById(`progress-${fileId}`);
                if (fill) fill.style.width = '100%';
            };
            reader.readAsArrayBuffer(file);
        }

        function handleFileStart(data) {
            if (fileTransferStates[data.id]) return;
            fileTransferStates[data.id] = { name: data.name, size: data.size, chunks: [], received: 0 };
            addMessage(data.sender, `Shared ${data.name}`, '', data.id);
        }

        function handleFileChunk(data) {
            const s = fileTransferStates[data.id];
            if (!s || s.chunks.some(c => c.index === data.index)) return;
            s.chunks.push({ index: data.index, data: data.chunk });
            s.received += data.chunk.byteLength;
            const fill = document.getElementById(`progress-${data.id}`);
            if (fill) fill.style.width = Math.round((s.received/s.size)*100) + '%';
            if (s.received >= s.size) {
                s.chunks.sort((a,b) => a.index - b.index);
                const url = URL.createObjectURL(new Blob(s.chunks.map(c => c.data)));
                const card = document.getElementById(`file-${data.id}`);
                card.innerHTML = `<button onclick="window.open('${url}')" style="width:100%; font-size:0.7rem;">Download File</button>`;
                delete fileTransferStates[data.id];
            }
        }

        document.getElementById('msg-input').onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
    </script>
</body>
</html>
