<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>shyChat - Secure Persistent Messaging</title>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration provided by environment
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'shychat-default';

        // UI State
        let currentRoomId = null;
        let myName = localStorage.getItem('shychat-name') || "";
        let user = null;

        // Initialize App
        const init = async () => {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (u) => {
                user = u;
                checkUrlParams();
            });
        };

        const checkUrlParams = () => {
            const params = new URLSearchParams(window.location.search);
            const chat = params.get('chat');
            if (chat) {
                currentRoomId = chat;
                if (myName) {
                    showView('chat-view');
                    listenForMessages();
                } else {
                    showView('name-view');
                }
            }
        };

        // UI Functions
        window.showView = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        window.startNewChat = () => {
            currentRoomId = "room-" + Math.random().toString(36).substring(2, 15);
            const link = `${window.location.origin}${window.location.pathname}?chat=${currentRoomId}`;
            document.getElementById('share-link').innerText = link;
            showView('link-view');
        };

        window.joinChat = () => {
            const input = document.getElementById('pseudonym-input').value.trim();
            if (!input) return;
            myName = input;
            localStorage.setItem('shychat-name', myName);
            showView('chat-view');
            listenForMessages();
        };

        window.copyLink = () => {
            const link = document.getElementById('share-link').innerText;
            navigator.clipboard.writeText(link);
            document.getElementById('share-link').innerText = "Copied to clipboard!";
            setTimeout(() => { document.getElementById('share-link').innerText = link; }, 2000);
        };

        // Messaging Logic
        let unsubscribe = null;
        const listenForMessages = () => {
            if (!user || !currentRoomId) return;
            if (unsubscribe) unsubscribe();

            const q = query(
                collection(db, 'artifacts', appId, 'public', 'data', `messages_${currentRoomId}`),
                orderBy('timestamp', 'asc')
            );

            unsubscribe = onSnapshot(q, (snapshot) => {
                const container = document.getElementById('messages');
                container.innerHTML = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    appendMessageUI(data);
                });
                container.scrollTop = container.scrollHeight;
            }, (err) => console.error("Firestore Error:", err));
        };

        const appendMessageUI = (data) => {
            const container = document.getElementById('messages');
            const isOwn = data.uid === user.uid;
            const div = document.createElement('div');
            div.className = `message ${isOwn ? 'own' : ''}`;
            
            div.innerHTML = `
                <div class="msg-sender">${data.sender}</div>
                <div>${data.text}</div>
            `;
            container.appendChild(div);
        };

        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !user || !currentRoomId) return;

            input.value = '';
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `messages_${currentRoomId}`), {
                    text: text,
                    sender: myName,
                    uid: user.uid,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Error sending:", e);
            }
        };

        // Event Listeners
        window.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && document.activeElement.id === 'msg-input') sendMessage();
        });

        init();
    </script>
    <style>
        :root { 
            --primary: #6366f1; 
            --bg: #f8fafc; 
            --text: #1e293b; 
            --panel: #ffffff;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        .view { display: none; width: 100%; max-width: 450px; padding: 2rem; flex-direction: column; gap: 1.5rem; text-align: center; }
        .view.active { display: flex; }

        #chat-view { max-width: 800px; width: 100%; height: 100vh; padding: 10px; }
        #chat-main { display: flex; flex-direction: column; height: 100%; background: white; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); overflow: hidden; }

        h1 { color: var(--primary); font-size: 2rem; }
        button { padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        input { padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; outline: none; }

        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: #f1f5f9; }
        .message { max-width: 80%; padding: 10px 15px; border-radius: 15px; background: white; align-self: flex-start; text-align: left; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message.own { align-self: flex-end; background: var(--primary); color: white; }
        .msg-sender { font-size: 0.7rem; font-weight: bold; margin-bottom: 3px; opacity: 0.7; }

        #input-area { padding: 15px; display: flex; gap: 10px; border-top: 1px solid #e2e8f0; }
        #msg-input { flex: 1; }

        .copy-box { padding: 15px; border: 2px dashed #cbd5e1; border-radius: 8px; cursor: pointer; font-family: monospace; font-size: 0.8rem; word-break: break-all; }
    </style>
</head>
<body>

    <div id="home-view" class="view active">
        <h1>shyChat</h1>
        <p>Private cloud-synced group messaging.</p>
        <button onclick="startNewChat()">Create Secure Room</button>
    </div>

    <div id="link-view" class="view">
        <h1>Invite Friends</h1>
        <div id="share-link" class="copy-box" onclick="copyLink()">Generating...</div>
        <button onclick="showView('name-view')">Enter Chat Room</button>
    </div>

    <div id="name-view" class="view">
        <h1>Who are you?</h1>
        <input type="text" id="pseudonym-input" placeholder="Enter your display name...">
        <button onclick="joinChat()">Start Chatting</button>
    </div>

    <div id="chat-view" class="view">
        <div id="chat-main">
            <div id="messages"></div>
            <div id="input-area">
                <input type="text" id="msg-input" placeholder="Type a message..." autocomplete="off">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

</body>
</html>
